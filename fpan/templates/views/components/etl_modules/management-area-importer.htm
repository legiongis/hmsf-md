{% extends "views/components/etl_modules/base-import.htm" %}
{% load i18n %}

{% block task_details %}
<!-- ko ifnot: loading() -->
    <div class="fmsf-etl" style="display:flex; flex-direction:column; height:calc(100vh - 100px);">
        <!-- ko ifnot: response() -->
        <div style="display:flex; flex-direction:row; overflow-y:hidden;">
            <div style="width:75%; padding:20px; overflow-y:scroll">
                <h2>Using the Management Area Importer</h2>
                <h3>Purpose</h3>
                <p>The Management Area Importer allows you to upload new Management Areas to the Arches backend, which can then be used to drive advanced access permission levels for any Archaeological Sites that overlap the areas. Any resource that overlaps a new Management Area will have that area's attributes joined to it (in the "Management" branch). These attributes drive permissions and search filtering.</p>
                <h3>Shapefile Requirements</h3>
                <p>Management Areas are imported via shapefile. The shapefile must fit the following criteria:</p>
                <ul>
                    <li>Must only contain new Management Areas of a single type. In other words, a single upload file can not have a state park and a state forest boundary within it.</li>
                    <li>Must be zipped with no nested directories</li>
                    <li>Must have a field called "Name" with an entry for each feature</li>
                    <li>Must be polygon or multipolygon geometry (no lines or points)</li>
                    <li>Must be reprojected to the WGS84 geometric coordinate reference system.<br>To reproject a layer in QGIS,
                        <ol>
                            <li>Right-click on the layer in the Layers panel</li>
                            <li>Choose <strong>Save Features As...</strong></li>
                            <li>Set the <strong>CRS</strong> property to <strong>EPSG:4326 - WGS84</strong></li>
                            <li>Save the layer as <strong>ESRI Shapefile</strong> format</li>
                            <li>Zip the shapefile and then begin the import process</li>
                        </ol>
                    </li>
                </ul>
                <h3>Reversing a Load</h3>
                <p>To reverse a load, you can delete the resulting Management Areas from the Django ORMs However: <strong>you must enter the edit page for each Management Area and click the delete button on that page, you cannot select multiple Management Areas and delete them all at once</strong>.</p>
            </div>
            <div class="file-select loader-select" style="width:25%; overflow-y:scroll;">
                <div data-bind="dropzone: dropzoneOptions">
                    <div class="manifest-manager-main-menu-circle loader-button">
                        <span><i style="color: #000" class="fa fa-cloud-upload r-select-icon"></i></span>
                    </div> 
                    <h2>{% trans 'Upload Your .zip File' %}</h2>
                    <div style="display: flex; padding: 15px 25px; flex-direction: column; justify-content: center; align-items: center;">
                        <div style="display:flex; flex-direction: column;">
                            <div>
                                <div class="dropzone-photo-upload">
                                    <div style="border-top: 1px solid #c4c4c4; margin-bottom: 15px;" class="btn btn-primary btn-labeled btn-lg fa fa-file fileinput-button dz-clickable" data-bind="css: uniqueidClass" role="button">
                                    {% trans 'Select File' %}
                                    </div>
                                    <div style="border-top: 1px solid #c4c4c4; margin-bottom: 15px;" class="btn btn-danger btn-labeled btn-lg fa fa-times-circle" data-bind="click: function() { $parent.cancel() }" role="button">
                                        {% trans 'Cancel File Import' %}
                                    </div>
                                    <div style="min-height: 100%;">
                                        <div id="hidden-dz-previews" style="display:none"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /ko -->
        <!-- ko if: response() -->
        <div class="branch-xl-metadata-container">
            <div style="display: grid; row-gap: 2px; height:fit-content; padding:15px 20px;">
                <div class="branch-xl-file-contents-container">
                    <h3 class="branch-xl-title">{% trans "File List" %}</h3> 
                    <div style="color: #333333">
                        <!--ko foreach: {data: response().result.Files, as: 'file'}-->
                        <div data-bind="text: file"></div>
                        <!-- /ko -->
                    </div>
                </div>
                <div>
                    <h3>Configuring the Import</h3>
                    <p> All of the incoming Management Areas will be assigned the same attributes, as defined on this page. These attributes can be changed later in the Django backend if needed.</p>
                    <div>
                        <label>
                            <strong>Management Area Category (required):</strong>
                            <select style="line-height:unset;" step="1" data-bind="value: maCategory">
                                <option value="---">---</option>
                                {% for i in ma_category_opts %}
                                <option value="{{ i.id }}">{{ i.name }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <p>The category determines how the incoming areas will be sorted on the backend, but it does not affect how permissions are handled for access to sites within the areas. To assign areas to a new category, you must first create the category and then return to this page.</p>
                        <p style="font-style:italic; margin-left: 5px;">
                            <a href="/admin/hms/managementareacategory/add/" target="_blank">Add a new category &nearr;</a>
                        </p>
                    </div>
                    <div>
                        <label>
                            <strong>Management Area Group (optional):</strong>
                            <select style="line-height:unset;" step="1" data-bind="value: maGroup">
                                <option value="---">---</option>
                                {% for i in ma_group_opts %}
                                <option value="{{ i.id }}">{{ i.name }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <p>Management Areas can be aggregated into groups, allowing for a broader range of permissions filters. For example, a user may get access to all archaeological sites on a single Management Area, or all sites on all Management Areas within a Management Area Group. To assign incoming areas to a group that does not exist, you must first create the group and then return to this page.</p>
                        <p style="font-style:italic; margin-left: 5px;">
                            <a href="/admin/hms/managementareagroup/add/" target="_blank">Add a new group &nearr;</a>
                        </p>
                    </div>
                    <div>
                        <label>
                            <strong>Management Agency (optional):</strong>
                            <select style="line-height:unset;" step="1" data-bind="value: maAgency">
                                <option value="---">---</option>
                                {% for i in ma_agency_opts %}
                                <option value="{{ i.code }}">{{ i.name }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <p>Some users will have their access to archaeological sites determined by their agency affiliation, which gets matched to the Management Agency attached to each group. Set the agency for the incoming Management Areas here if needed. To assign incoming Management Areas to a group that does not exist, you must first create the group and then return to this page.</p>
                        <p style="font-style:italic; margin-left: 5px;">
                            <a href="/admin/hms/managementagency/add/" target="_blank">Add a new agency &nearr;</a>
                        </p>
                    </div>
                    <div>
                        <label>
                            <strong>Management Area Level (recommended):</strong>
                            <select style="line-height:unset;" step="1" data-bind="value: maLevel">
                                <option value="---">---</option>
                                {% for i in ma_level_opts %}
                                <option value="{{ i.0 }}">{{ i.1 }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <p>Management Area Level is a placeholder attribute that we may need to use in the future. It is best to assign a level to the incoming areas, if one of the provided levels fits.</p>
                    </div>
                    <div>
                        <label>
                            <strong>Load description (optional):</strong>
                            <input style="width:unset; height:unset;" data-bind="value: loadDescription">
                        </label>
                    </div>
                    <!-- <div>
                        <label>
                            <strong>Update existing:</strong>
                            <input type="checkbox" style="width:unset; height:unset;" data-bind="checked: overwrite">
                        </label>
                        <p style="font-style:italic; margin-left: 5px;">Existing Management Areas with the same <strong>Name + File Name</strong> will be  .</p>
                    </div> -->
                </div>
            </div>
        </div>

        <div  class="tabbed-workflow-footer, etl-module-footer">
           <button class="btn btn-shim btn-labeled btn-lg fa fa-check btn-primary" style="margin-right: 8px;" data-bind="click: function(){ start(); }">{% trans "Begin Import" %}</button>
        </div>
        <!-- /ko -->
    </div>
<!--/ko-->
{% endblock task_details %}

{% block etl_status %}
{% endblock etl_status %}
